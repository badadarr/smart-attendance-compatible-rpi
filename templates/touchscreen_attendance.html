<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, shrink-to-fit=no"
    />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta
      name="apple-mobile-web-app-status-bar-style"
      content="black-translucent"
    />
    <meta name="format-detection" content="telephone=no" />
    <!-- PWA Support for 5-inch displays -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Attendance System">
    <meta name="msapplication-TileColor" content="#2c3e50">
    <!-- Prevent browser UI on fullscreen 5-inch displays -->
    <meta name="msapplication-tap-highlight" content="no">
    <meta name="apple-touch-fullscreen" content="yes">
    <title>Touchscreen Attendance System - 5" Display</title>
    <style>
      /* CSS Variables for 5-inch display optimizations */
      :root {
        --animation-duration: 0.2s;
        --touch-feedback-scale: 0.95;
        --border-radius-base: 8px;
        --font-size-base: 12px;
        --spacing-base: 10px;
        --button-height-base: 45px;
        --button-height-primary: 55px;
      }
      
      /* Hardware acceleration for smooth touch interactions */
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        -webkit-transform: translateZ(0);
        transform: translateZ(0);
        -webkit-backface-visibility: hidden;
        backface-visibility: hidden;
      }
        body {
        background: linear-gradient(135deg, #2c3e50, #3498db);
        font-family: "Arial", sans-serif;
        height: 100vh;
        overflow: hidden;
        touch-action: manipulation;
        font-size: 12px; /* Base font for displays */
        -webkit-user-select: none; /* Prevent text selection on touch */
        -webkit-touch-callout: none; /* Disable callout on iOS */
        user-select: none;
        /* Hardware acceleration */
        -webkit-transform: translate3d(0, 0, 0);
        transform: translate3d(0, 0, 0);
        /* Prevent text size adjustment on orientation change */
        -webkit-text-size-adjust: 100%;
        -ms-text-size-adjust: 100%;
        text-size-adjust: 100%;
      }

      .container {
        display: flex;
        height: 100vh;
        padding: 10px; /* Reduced padding for 5-inch display */
        gap: 10px; /* Reduced gap */
        /* GPU acceleration for smooth animations */
        will-change: transform;
      }
      .camera-section {
        flex: 2;
        display: flex;
        flex-direction: column;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px; /* Reduced border radius */
        padding: 10px; /* Reduced padding for 5-inch display */
        -webkit-backdrop-filter: blur(10px); /* Safari support */
        backdrop-filter: blur(10px);
      }
      .controls-section {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 10px; /* Reduced gap for 5-inch display */
      }
      .video-container {
        position: relative;
        flex: 1;
        background: #000;
        border-radius: 8px; /* Reduced for 5-inch display */
        overflow: hidden;
        margin-bottom: 10px; /* Reduced margin */
      }

      #videoFeed {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .status-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 8px; /* Reduced padding for 5-inch display */
        font-size: 14px; /* Reduced font size */
        font-weight: bold;
      }
      .recognized-info {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 8px; /* Reduced padding for 5-inch display */
        display: none;
      }
      .touch-button {
        background: linear-gradient(145deg, #3498db, #2980b9);
        border: none;
        border-radius: 10px;
        color: white;
        font-size: 18px;
        font-weight: bold;
        padding: 15px;
        cursor: pointer;
        transition: all 0.2s ease; /* Faster transition for touch */
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
        min-height: 60px;
        touch-action: manipulation;
        -webkit-user-select: none;
        user-select: none;
        -webkit-tap-highlight-color: rgba(
          0,
          0,
          0,
          0
        ); /* Remove tap highlight */
        position: relative;
        overflow: hidden;
      }

      .touch-button:active {
        transform: translateY(2px) scale(0.98); /* Better touch feedback */
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      }

      /* Add ripple effect for better touch feedback */
      .touch-button::before {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        width: 0;
        height: 0;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.3);
        transform: translate(-50%, -50%);
        transition: width 0.3s, height 0.3s;
        pointer-events: none;
      }
      .touch-button:active::before {
        width: 100px;
        height: 100px;
      }

      /* Button pressed state for better touch feedback */
      .touch-button.button-pressed {
        transform: translateY(2px) scale(0.95);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
      }

      /* Specific optimizations when 5-inch display is detected */
      body.five-inch-display {
        font-size: 11px;
      }

      body.five-inch-display .container {
        padding: 6px;
        gap: 6px;
      }

      body.five-inch-display .touch-button {
        font-size: 14px;
        padding: 12px;
        min-height: 50px;
      }

      body.five-inch-display .record-btn {
        font-size: 16px;
        min-height: 60px;
      }

      body.five-inch-display .status-overlay {
        font-size: 10px;
        padding: 4px;
      }

      body.five-inch-display .attendance-item {
        font-size: 9px;
        padding: 3px;
      }
      .record-btn {
        background: linear-gradient(145deg, #27ae60, #229954);
        font-size: 20px; /* Reduced font size for 5-inch display */
        min-height: 70px; /* Reduced height */
      }

      .record-btn:hover {
        background: linear-gradient(145deg, #229954, #1e8449);
      }

      .record-btn:disabled {
        background: linear-gradient(145deg, #95a5a6, #7f8c8d);
        cursor: not-allowed;
      }

      .auto-btn {
        background: linear-gradient(145deg, #f39c12, #e67e22);
      }

      .auto-btn.active {
        background: linear-gradient(145deg, #e74c3c, #c0392b);
      }

      .exit-btn {
        background: linear-gradient(145deg, #e74c3c, #c0392b);
      }
      .info-panel {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 10px; /* Reduced border radius */
        padding: 12px; /* Reduced padding for 5-inch display */
        -webkit-backdrop-filter: blur(10px); /* Safari support */
        backdrop-filter: blur(10px);
        color: white;
      }

      .info-panel h3 {
        margin-bottom: 10px; /* Reduced margin */
        color: #ecf0f1;
        border-bottom: 2px solid rgba(255, 255, 255, 0.3);
        padding-bottom: 8px; /* Reduced padding */
        font-size: 16px; /* Reduced font size */
      }
      .attendance-list {
        max-height: 150px; /* Reduced height for 5-inch display */
        overflow-y: auto;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 8px; /* Reduced border radius */
        padding: 8px; /* Reduced padding */
      }

      .attendance-item {
        background: rgba(255, 255, 255, 0.1);
        margin: 3px 0; /* Reduced margin */
        padding: 6px; /* Reduced padding */
        border-radius: 6px; /* Reduced border radius */
        font-size: 12px; /* Reduced font size for 5-inch display */
      }
      .notification {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 20px 30px; /* Reduced padding for 5-inch display */
        border-radius: 10px; /* Reduced border radius */
        font-size: 18px; /* Reduced font size */
        font-weight: bold;
        z-index: 1000;
        display: none;
      }

      .notification.success {
        background: rgba(39, 174, 96, 0.9);
      }

      .notification.error {
        background: rgba(231, 76, 60, 0.9);
      }

      .system-status {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
      }

      .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #e74c3c;
      }

      .status-indicator.active {
        background: #27ae60;
      } /* Optimized specifically for 5-inch HDMI displays (800x480) */
      @media screen and (max-width: 850px) and (max-height: 550px) {
        body {
          font-size: 11px;
          overflow: hidden;
        }

        .container {
          height: 100vh;
          padding: 8px;
          gap: 8px;
          display: flex;
          flex-direction: row; /* Keep horizontal layout for better use of width */
        }

        .camera-section {
          flex: 2.5;
          min-width: 480px; /* Ensure camera gets adequate space */
        }

        .controls-section {
          flex: 1;
          min-width: 280px;
          display: flex;
          flex-direction: column;
          justify-content: space-between;
        }

        .video-container {
          height: 360px; /* Fixed height for 480p display */
          margin-bottom: 8px;
        }

        .status-overlay {
          padding: 6px;
          font-size: 11px;
        }

        .system-status {
          gap: 8px;
          margin-bottom: 8px;
        }

        .status-indicator {
          width: 10px;
          height: 10px;
        }

        .touch-button {
          font-size: 14px;
          padding: 10px;
          min-height: 45px;
          border-radius: 8px;
        }

        .record-btn {
          font-size: 16px;
          min-height: 55px;
          margin-bottom: 8px;
        }

        .auto-btn {
          font-size: 13px;
          min-height: 40px;
          margin-bottom: 8px;
        }

        .info-panel {
          padding: 8px;
          flex: 1;
          margin-bottom: 8px;
        }

        .info-panel h3 {
          font-size: 13px;
          margin-bottom: 6px;
          padding-bottom: 4px;
        }

        .attendance-list {
          max-height: 120px;
          font-size: 10px;
        }

        .attendance-item {
          padding: 4px;
          margin: 2px 0;
          font-size: 10px;
          line-height: 1.2;
        }

        .exit-btn {
          font-size: 12px;
          min-height: 35px;
          padding: 8px;
        }

        .recognized-info {
          padding: 6px;
          font-size: 11px;
        }

        .notification {
          font-size: 14px;
          padding: 15px 20px;
        }
      }

      /* For very small screens or portrait orientation */
      @media screen and (max-width: 600px) or (max-height: 400px) {
        .container {
          flex-direction: column;
          padding: 5px;
          gap: 5px;
        }

        .camera-section {
          height: 250px;
          min-width: auto;
        }

        .controls-section {
          min-width: auto;
          flex-direction: row;
          flex-wrap: wrap;
          gap: 5px;
        }

        .touch-button {
          flex: 1;
          min-width: 120px;
          font-size: 12px;
          min-height: 35px;
        }

        .info-panel {
          order: -1;
          width: 100%;
          margin-bottom: 5px;
        }
      }

      /* Landscape optimization for 5-inch displays */
      @media screen and (min-width: 800px) and (max-height: 500px) {
        .container {
          padding: 5px;
          gap: 5px;
        }

        .camera-section {
          flex: 3;
        }

        .controls-section {
          flex: 1;
          min-width: 200px;
        }

        .video-container {
          height: calc(100vh - 20px);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <!-- Camera Section -->
      <div class="camera-section">
        <div class="video-container">
          <img
            id="videoFeed"
            src="{{ url_for('video_feed') }}"
            alt="Camera Feed"
          />
          <div class="status-overlay">
            <div class="system-status">
              <div class="status-indicator" id="cameraStatus"></div>
              <span
                >Camera: <span id="cameraStatusText">Connecting...</span></span
              >
              <div class="status-indicator" id="autoModeStatus"></div>
              <span>Auto Mode: <span id="autoModeText">OFF</span></span>
            </div>
            <div id="recognitionStatus">Looking for faces...</div>
          </div>
          <div class="recognized-info" id="recognizedInfo">
            <div id="recognizedName"></div>
            <div id="recognizedConfidence"></div>
          </div>
        </div>
      </div>

      <!-- Controls Section -->
      <div class="controls-section">
        <!-- Record Button -->
        <button class="touch-button record-btn" id="recordBtn" disabled>
          üìù RECORD ATTENDANCE
        </button>

        <!-- Auto Mode Button -->
        <button class="touch-button auto-btn" id="autoBtn">
          ü§ñ AUTO MODE: OFF
        </button>

        <!-- Info Panel -->
        <div class="info-panel">
          <h3>üìä Today's Attendance</h3>
          <div class="attendance-list" id="attendanceList">
            <div class="attendance-item">Loading...</div>
          </div>
        </div>

        <!-- Exit Button -->
        <button class="touch-button exit-btn" onclick="window.close()">
          üö™ EXIT
        </button>
      </div>
    </div>

    <!-- Notification -->
    <div class="notification" id="notification"></div>

    <script>
      let autoMode = false;
      let currentRecognition = null;

      // Get DOM elements
      const recordBtn = document.getElementById("recordBtn");
      const autoBtn = document.getElementById("autoBtn");
      const notification = document.getElementById("notification");
      const recognitionStatus = document.getElementById("recognitionStatus");
      const recognizedInfo = document.getElementById("recognizedInfo");
      const recognizedName = document.getElementById("recognizedName");
      const recognizedConfidence = document.getElementById(
        "recognizedConfidence"
      );
      const attendanceList = document.getElementById("attendanceList");
      const cameraStatus = document.getElementById("cameraStatus");
      const cameraStatusText = document.getElementById("cameraStatusText");
      const autoModeStatus = document.getElementById("autoModeStatus");
      const autoModeText = document.getElementById("autoModeText");

      // Show notification
      function showNotification(message, type = "success") {
        notification.textContent = message;
        notification.className = `notification ${type}`;
        notification.style.display = "block";

        setTimeout(() => {
          notification.style.display = "none";
        }, 3000);
      }

      // Record attendance
      recordBtn.addEventListener("click", () => {
        if (!currentRecognition) {
          showNotification("No face recognized!", "error");
          return;
        }

        fetch("/api/record_attendance", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              showNotification(data.message, "success");
              loadTodayAttendance();
            } else {
              showNotification(data.message, "error");
            }
          })
          .catch((error) => {
            showNotification("Error recording attendance", "error");
            console.error("Error:", error);
          });
      });

      // Toggle auto mode
      autoBtn.addEventListener("click", () => {
        fetch("/api/toggle_auto_mode", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              autoMode = data.auto_mode;
              updateAutoModeUI();
              showNotification(data.message, "success");
            }
          })
          .catch((error) => {
            showNotification("Error toggling auto mode", "error");
            console.error("Error:", error);
          });
      });

      // Update auto mode UI
      function updateAutoModeUI() {
        if (autoMode) {
          autoBtn.textContent = "ü§ñ AUTO MODE: ON";
          autoBtn.classList.add("active");
          autoModeStatus.classList.add("active");
          autoModeText.textContent = "ON";
        } else {
          autoBtn.textContent = "ü§ñ AUTO MODE: OFF";
          autoBtn.classList.remove("active");
          autoModeStatus.classList.remove("active");
          autoModeText.textContent = "OFF";
        }
      }

      // Update recognition UI
      function updateRecognitionUI(recognition) {
        if (recognition) {
          currentRecognition = recognition;
          recognitionStatus.textContent = `Ready to record: ${recognition.name}`;
          recognizedInfo.style.display = "block";
          recognizedName.textContent = `Name: ${recognition.name}`;
          recognizedConfidence.textContent = `Confidence: ${(
            recognition.confidence * 100
          ).toFixed(1)}%`;
          recordBtn.disabled = false;
        } else {
          currentRecognition = null;
          recognitionStatus.textContent = "Looking for faces...";
          recognizedInfo.style.display = "none";
          recordBtn.disabled = true;
        }
      }

      // Load today's attendance
      function loadTodayAttendance() {
        fetch("/api/attendance_today")
          .then((response) => response.json())
          .then((data) => {
            attendanceList.innerHTML = "";
            if (data.records && data.records.length > 0) {
              data.records.forEach((record) => {
                const item = document.createElement("div");
                item.className = "attendance-item";
                item.innerHTML = `
                            <strong>${record.NAME}</strong><br>
                            ${record.TIME} - ${record.STATUS}
                        `;
                attendanceList.appendChild(item);
              });
            } else {
              attendanceList.innerHTML =
                '<div class="attendance-item">No records yet today</div>';
            }
          })
          .catch((error) => {
            console.error("Error loading attendance:", error);
            attendanceList.innerHTML =
              '<div class="attendance-item">Error loading data</div>';
          });
      }

      // Check system status
      function checkStatus() {
        fetch("/api/status")
          .then((response) => response.json())
          .then((data) => {
            // Update auto mode
            autoMode = data.auto_mode;
            updateAutoModeUI();

            // Update recognition status
            updateRecognitionUI(data.current_recognition);

            // Update camera status
            cameraStatus.classList.add("active");
            cameraStatusText.textContent = "Connected";
          })
          .catch((error) => {
            console.error("Status check error:", error);
            cameraStatus.classList.remove("active");
            cameraStatusText.textContent = "Error";
          });
      }

      // Initialize
      document.addEventListener("DOMContentLoaded", () => {
        loadTodayAttendance();
        checkStatus();

        // Set up periodic status checks
        setInterval(checkStatus, 1000);
        setInterval(loadTodayAttendance, 5000);
      });

      // Handle video feed errors
      document.getElementById("videoFeed").addEventListener("error", () => {
        cameraStatus.classList.remove("active");
        cameraStatusText.textContent = "Error";
      });

      document.getElementById("videoFeed").addEventListener("load", () => {
        cameraStatus.classList.add("active");
        cameraStatusText.textContent = "Connected";
      }); // Prevent context menu on touch devices
      document.addEventListener("contextmenu", (e) => e.preventDefault());

      // Enhanced touch handling for 5-inch displays
      let lastTouchEnd = 0;
      let pinchStartDistance = 0;

      // Prevent zoom on double tap and pinch
      document.addEventListener(
        "touchend",
        (event) => {
          const now = new Date().getTime();
          if (now - lastTouchEnd <= 300) {
            event.preventDefault();
          }
          lastTouchEnd = now;
        },
        false
      );

      // Prevent pinch zoom
      document.addEventListener(
        "touchstart",
        (event) => {
          if (event.touches.length > 1) {
            event.preventDefault();
          }
        },
        { passive: false }
      );

      document.addEventListener(
        "touchmove",
        (event) => {
          if (event.touches.length > 1) {
            event.preventDefault();
          }
        },
        { passive: false }
      );

      // Auto-resize for 5-inch display optimization
      function optimizeFor5InchDisplay() {
        const screenWidth = window.screen.width;
        const screenHeight = window.screen.height;
        const windowWidth = window.innerWidth;
        const windowHeight = window.innerHeight;

        // Enhanced detection for 5-inch displays
        const is5InchDisplay = 
          (screenWidth === 800 && screenHeight === 480) ||
          (screenWidth === 480 && screenHeight === 800) ||
          (windowWidth <= 850 && windowHeight <= 550) ||
          // Common 5-inch display resolutions
          (screenWidth === 854 && screenHeight === 480) ||
          (screenWidth === 960 && screenHeight === 540);

        if (is5InchDisplay) {
          document.body.classList.add("five-inch-display");

          // Advanced optimizations for 5-inch displays
          const videoFeed = document.getElementById("videoFeed");
          if (videoFeed) {
            videoFeed.style.objectFit = "cover";
            // Reduce video quality slightly for better performance
            videoFeed.style.imageRendering = "optimizeSpeed";
          }

          // Optimize CSS animations for touch performance
          document.documentElement.style.setProperty('--animation-duration', '0.15s');
          
          // Adjust touch target sizes dynamically
          const buttons = document.querySelectorAll('.touch-button');
          buttons.forEach(button => {
            button.style.minHeight = '48px';
            button.style.fontSize = '13px';
          });

          // Optimize record button for better visibility
          const recordBtn = document.getElementById('recordBtn');
          if (recordBtn) {
            recordBtn.style.minHeight = '58px';
            recordBtn.style.fontSize = '15px';
          }

          console.log("Enhanced 5-inch display optimization applied");
          console.log(`Screen: ${screenWidth}x${screenHeight}, Window: ${windowWidth}x${windowHeight}`);
        }
      }

      // Performance optimization for 5-inch displays
      function optimize5InchPerformance() {
        // Reduce update frequency for battery-powered devices
        if (document.body.classList.contains('five-inch-display')) {
          // Slower status updates to save CPU
          clearInterval(window.statusInterval);
          clearInterval(window.attendanceInterval);
          
          window.statusInterval = setInterval(checkStatus, 2000); // Reduced from 1000ms
          window.attendanceInterval = setInterval(loadTodayAttendance, 8000); // Reduced from 5000ms
          
          console.log("Performance optimizations applied for 5-inch display");
        }
      }
      // Initialize display optimization
      window.addEventListener("load", () => {
        optimizeFor5InchDisplay();
        optimize5InchPerformance();
      });
      window.addEventListener("resize", () => {
        optimizeFor5InchDisplay();
        optimize5InchPerformance();
      });

      // Improve button feedback for touch
      document.querySelectorAll(".touch-button").forEach((button) => {
        button.addEventListener("touchstart", function (e) {
          this.classList.add("button-pressed");
        });

        button.addEventListener("touchend", function (e) {
          setTimeout(() => {
            this.classList.remove("button-pressed");
          }, 150);
        });
      });
    </script>
  </body>
</html>
